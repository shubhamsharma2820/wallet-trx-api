service: wallet-coin-api
frameworkVersion: '3'

plugins:
  - serverless-deployment-bucket
  - serverless-iam-roles-per-function
  # - serverless-domain-manager
  # - serverless-associate-waf

custom:
  project: spark
  projectKey: SPK
  region: ap-south-1
  # domain:
  #   dev: dev.withspark.club
  #   test: test.withspark.club
  #   prod: api.withspark.club
  # customDomain:
  #   domainName: ${self:custom.domain.${opt:stage}}
  #   basePath: 'kyc'
  #   stage: ${opt:stage}
  #   createRoute53Record: false
  associateWaf:
    name: spark-resources-ACL
    version: V2  

provider:
  name: aws
  runtime: nodejs18.x
  region: ${self:custom.region}
  stackName: ${self:service}-stack
  deploymentBucket:
    name: spark-app-deployment-bucket-${opt:stage}
  stackTags:
    project: ${self:custom.project}
  memorySize: 128
  timeout: 90
  logs:
    frameworkLambda: true
    restApi: true
  tags:
    project: ${self:custom.project}
  architecture: arm64
  environment:
    REGION: ${self:custom.region}

resources:
  Resources:
    ApiGatewayRestApi:
      Type: AWS::ApiGateway::RestApi
      Properties:
        Name: ${self:service}
        Description: Create and Get wallet and coin transactions.

    # UserPoolAuthorizer:
    #   Type: AWS::ApiGateway::Authorizer
    #   Properties:
    #     Name: jwt-authorizer-spark
    #     Type: COGNITO_USER_POOLS
    #     ProviderARNs:
    #       - !ImportValue UserPoolArn
    #     # The lenght of time(in seconds) that the authorizer results should be cached
    #     AuthorizerResultTtlInSeconds: 180
    #     RestApiId: 
    #       Ref: ApiGatewayRestApi
    #     IdentitySource: method.request.header.Authorization

functions:
  create-wallet-transaction:
    handler: functions/wallet/create-wallet-transaction.createWalletTransaction
    name: ${self:service}-wallet-transaction
    description: Wallet transaction created in wallet Table.
    timeout: 30 #seconds
    memorySize: 128 #mb
    events:
      - http:
          path: 'wallet'
          method: POST
          # authorizer:
          #   type: COGNITO_USER_POOLS
          #   authorizerId:
          #     Ref: UserPoolAuthorizer          
    iamRoleStatementsName: ${self:service}-walletTransaction-lambda-role
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:PutItem
        Resource: !ImportValue WalletTransactionArn
    environment:
      WALLET_TRANSACTION_TABLE: WalletTransaction
    package:
      individually: true
      patterns:
        - '!functions/**'
        - '!node_modules'
        - '!node_modules/@aws-sdk' 
        - 'functions/wallet/create-wallet-transaction.mjs'

  get-wallet-transaction:
    handler: functions/wallet/get-wallet-transactions.getWalletTransactions
    name: ${self:service}-userall-wallet-transaction
    description: user all Wallet transaction in wallet Table.
    timeout: 30 #seconds
    memorySize: 128 #mb
    events:
      - http:
          path: 'userwallettransaction/{userId}'
          method: POST
          # authorizer:
          #   type: COGNITO_USER_POOLS
          #   authorizerId:
          #     Ref: UserPoolAuthorizer          
    iamRoleStatementsName: ${self:service}-userwalletTransaction-lambda-role
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource: !ImportValue WalletTransactionArn
    environment:
      WALLET_TRANSACTION_TABLE: WalletTransaction
    package:
      individually: true
      patterns:
        - '!functions/**'
        - '!node_modules'
        - '!node_modules/@aws-sdk' 
        - 'functions/wallet/get-wallet-transactions.mjs'

  get-bor-transaction:
    handler: functions/wallet/get-bor-transaction.getBorBaesdWalletTransaction
    name: ${self:service}-user-all-bor-wallet-transaction
    description: user all bor based Wallet transaction in wallet Table.
    timeout: 30 #seconds
    memorySize: 128 #mb
    events:
      - http:
          path: 'borwallettransaction/{userId}'   #bor = based on referenceId
          method: POST
          # authorizer:
          #   type: COGNITO_USER_POOLS
          #   authorizerId:
          #     Ref: UserPoolAuthorizer          
    iamRoleStatementsName: ${self:service}-userBORwalletTransaction-lambda-role
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource: !ImportValue WalletTransactionArn
    environment:
      WALLET_TRANSACTION_TABLE: WalletTransaction
    package:
      individually: true
      patterns:
        - '!functions/**'
        - '!node_modules'
        - '!node_modules/@aws-sdk' 
        - 'functions/wallet/get-bor-transaction.mjs'

  get-all-walletbor-transaction:
    handler: functions/wallet/get-reference-based-transaction.getBorBaesdAllWalletTransaction
    name: ${self:service}-all-bor-based-wallet-transaction
    description: all bor based Wallet transaction in wallet Table.
    timeout: 30 #seconds
    memorySize: 128 #mb
    events:
      - http:
          path: 'allborwallettransaction'   #bor = based on referenceId
          method: POST
          # authorizer:
          #   type: COGNITO_USER_POOLS
          #   authorizerId:
          #     Ref: UserPoolAuthorizer          
    iamRoleStatementsName: ${self:service}-allBORwalletTransaction-lambda-role
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource: !ImportValue WalletTransactionArn
    environment:
      WALLET_TRANSACTION_TABLE: WalletTransaction
    package:
      individually: true
      patterns:
        - '!functions/**'
        - '!node_modules'
        - '!node_modules/@aws-sdk' 
        - 'functions/wallet/get-reference-based-transaction.mjs'

  create-coin-transaction:
    handler: functions/coin/create-coin-transaction.createCoinTransaction
    name: ${self:service}-coin-transaction
    description: coin transaction created in coin Table.
    timeout: 30 #seconds
    memorySize: 128 #mb
    events:
      - http:
          path: 'coin'
          method: POST
          # authorizer:
          #   type: COGNITO_USER_POOLS
          #   authorizerId:
          #     Ref: UserPoolAuthorizer          
    iamRoleStatementsName: ${self:service}-coinTransaction-lambda-role
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:PutItem
        Resource: !ImportValue CoinTransactionTableArn
    environment:
      COIN_TRANSACTION_TABLE: CoinTransaction
    package:
      individually: true
      patterns:
        - '!functions/**'
        - '!node_modules'
        - '!node_modules/@aws-sdk' 
        - 'functions/coin/create-coin-transaction.mjs'

  get-coin-transaction:
    handler: functions/coin/get-coin-transactions.getCoinTransactions
    name: ${self:service}-user-all-coin-transaction
    description: user all coin transaction in coin Table.
    timeout: 30 #seconds
    memorySize: 128 #mb
    events:
      - http:
          path: 'usercointransaction/{userId}'
          method: POST
          # authorizer:
          #   type: COGNITO_USER_POOLS
          #   authorizerId:
          #     Ref: UserPoolAuthorizer          
    iamRoleStatementsName: ${self:service}-usercoinTransaction-lambda-role
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource: !ImportValue CoinTransactionTableArn
    environment:
      COIN_TRANSACTION_TABLE: CoinTransaction
    package:
      individually: true
      patterns:
        - '!functions/**'
        - '!node_modules'
        - '!node_modules/@aws-sdk' 
        - 'functions/coin/get-coin-transactions.mjs'

  get-bor-coin-transaction:
    handler: functions/coin/get-bor-coin-transaction.getBorBaesdcoinTransaction
    name: ${self:service}-user-all-bor-coin-transaction
    description: user all bor based coin transaction in coin Table.
    timeout: 30 #seconds
    memorySize: 128 #mb
    events:
      - http:
          path: 'borcointransaction/{userId}'   #bor = based on referenceId
          method: POST
          # authorizer:
          #   type: COGNITO_USER_POOLS
          #   authorizerId:
          #     Ref: UserPoolAuthorizer          
    iamRoleStatementsName: ${self:service}-userBORcoinTransaction-lambda-role
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource: !ImportValue CoinTransactionTableArn
    environment:
      COIN_TRANSACTION_TABLE: CoinTransaction
    package:
      individually: true
      patterns:
        - '!functions/**'
        - '!node_modules'
        - '!node_modules/@aws-sdk' 
        - 'functions/coin/get-bor-coin-transaction.mjs'

  get-all-cointbor-transaction:
    handler: functions/coin/get-referenceId-based-coin-transaction.getBorBaesdAllCoinTransaction
    name: ${self:service}-all-bor-based-coin-transaction
    description: all bor based Coin transaction in coin Table.
    timeout: 30 #seconds
    memorySize: 128 #mb
    events:
      - http:
          path: 'allbor-coin-transaction'   #bor = based on referenceId
          method: POST
          # authorizer:
          #   type: COGNITO_USER_POOLS
          #   authorizerId:
          #     Ref: UserPoolAuthorizer          
    iamRoleStatementsName: ${self:service}-allBORcoinTransaction-lambda-role
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource: !ImportValue CoinTransactionTableArn
    environment:
      COIN_TRANSACTION_TABLE: CoinTransaction
    package:
      individually: true
      patterns:
        - '!functions/**'
        - '!node_modules'
        - '!node_modules/@aws-sdk' 
        - 'functions/coin/get-referenceId-based-coin-transaction.mjs'


package:
  individually: true
  patterns:
    - '!package-lock.json'
    - '!README.md'
    - '!.gitignore'
    - '!yml'
    - '!.*/**'